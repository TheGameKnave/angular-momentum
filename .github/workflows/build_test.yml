name: Build and SonarQube Analysis
on:
  push:
    branches:
      - '**'

jobs:
  build-and-test:
    runs-on: macos-latest
    env:
      PORT: 4201
      APP_PORT: 4200

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set Up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 24.11.1

      - name: Install Dependencies
        run: |
          echo "\nInstalling dependencies\n\n"
          npm ci

      - name: Run Translation Validation
        run: |
          echo "\nRunning translation validation\n\n"
          cd tests/translation && npx tsx translation-validation.ts
          echo "\nRunning translation key usage check\n\n"
          npx tsx translation-key-usage.ts

      - name: Run Client ESLint
        run: cd client && npx eslint --ext .ts,.js src/

      - name: Run Server ESLint
        run: cd server && npx eslint .

      - name: Build the Client
        run: |
          echo "\nBuilding the client\n\n"
          cd client && npm run build

      - name: Build the Server
        run: |
          echo "\nBuilding the server\n\n"
          cd server && npx tsc

      - name: Run Server Tests
        run: |
          echo "\nRunning server tests\n\n"
          cd server && npm test

      - name: Run Client Tests
        run: |
          echo "\nRunning client tests\n\n"
          cd client && npm test

      # E2E Tests with Playwright
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Create server .env for E2E tests
        run: |
          echo "API_PORT=4201" > server/.env
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> server/.env
          echo "SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}" >> server/.env

      - name: Run E2E Tests
        run: |
          echo "\nRunning e2e tests\n\n"
          npx playwright test --config=tests/e2e/playwright.config.ts --project=chromium --project=chromium-features --project=chromium-feature-toggles
        env:
          CI: true

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: tests/e2e/playwright-report/
          retention-days: 7

      - name: Upload Visual Diff Artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-diff-results
          path: tests/e2e/test-results/
          retention-days: 7

      # Lighthouse CI - runs against SSR production build
      - name: Run Lighthouse CI
        run: |
          npm install -g --ignore-scripts @lhci/cli
          # Start the API server in background (SSR proxies to it)
          node server/build/server/index.js &
          API_PID=$!
          sleep 2
          # Start the SSR server in background
          node client/dist/angular-momentum/server/server.mjs &
          SSR_PID=$!
          # Wait for SSR server to be ready (check HTTP status code)
          for i in {1..30}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:4000 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "SSR server is ready (HTTP $HTTP_CODE)"
              break
            fi
            echo "Waiting for SSR server... ($i/30, HTTP $HTTP_CODE)"
            sleep 1
          done
          # Run Lighthouse using config file
          lhci autorun || true
          # Cleanup
          kill $SSR_PID 2>/dev/null || true
          kill $API_PID 2>/dev/null || true

      - name: Upload Lighthouse Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: .lighthouseci/
          retention-days: 30

      - name: Install SonarScanner
        run: |
          curl -sSLo sonar-scanner-cli.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-6.2.1.4610-macosx-aarch64.zip
          unzip -q sonar-scanner-cli.zip -d $HOME/sonar-scanner
          echo "$HOME/sonar-scanner/sonar-scanner-6.2.1.4610-macosx-aarch64/bin" >> $GITHUB_PATH

      - name: Run SonarScanner
        run: |
          sonar-scanner \
            -Dsonar.projectKey=TheGameKnave_angular-momentum \
            -Dsonar.organization=thegameknave \
            -Dsonar.host.url=https://sonarcloud.io
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Wait for Quality Gate
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          #!/bin/bash
          TASK_FILE=.scannerwork/report-task.txt
          echo "Fetching task status... for TASK_ID=$(cat $TASK_FILE)"
          TASK_ID=$(grep "ceTaskId" "$TASK_FILE" | cut -d= -f2 | tr -d '[:space:]')

          if [[ -z "$TASK_ID" ]]; then
            echo "Error: TASK_ID is empty. Check Sonar task file."
            exit 1
          fi

          # Wait for SonarCloud to complete the analysis
          MAX_RETRIES=15
          RETRY_DELAY=10
          TRIES=0

          while ((TRIES < MAX_RETRIES)); do
            # Fetch task status from SonarCloud
            RESPONSE=$(curl -s -u "$SONAR_TOKEN:" "https://sonarcloud.io/api/ce/task?id=$TASK_ID")
            echo "Response: $RESPONSE"  # This logs the response from SonarCloud
            
            # Check if the response contains data
            if [[ -z "$RESPONSE" ]]; then
              echo "Warning: Empty response from SonarCloud. Retrying..."
              sleep $RETRY_DELAY
              ((TRIES++))
              continue
            fi

            # Attempt to extract the status from the response
            STATUS=$(echo "$RESPONSE" | grep -o '"status":"[^"]*"' | cut -d: -f2 | tr -d '"')
            
            if [[ -z "$STATUS" ]]; then
              echo "Warning: STATUS is empty. Retrying..."
              sleep $RETRY_DELAY
              ((TRIES++))
              continue
            fi

            echo "Current Task Status: $STATUS"

            if [[ "$STATUS" == "SUCCESS" ]]; then
              break
            elif [[ "$STATUS" == "FAILED" ]]; then
              echo "SonarCloud analysis failed!"
              echo "$RESPONSE"  # Show full response on failure
              exit 1
            fi

            ((TRIES++))
            if [[ "$TRIES" -ge "$MAX_RETRIES" ]]; then
              echo "SonarCloud analysis taking too long. Exiting."
              exit 1
            fi

            echo "Waiting for SonarCloud to complete analysis... (Attempt $TRIES/$MAX_RETRIES)"
            sleep $RETRY_DELAY
          done
        shell: bash

  create-release-tag:
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for tags
          token: ${{ secrets.GH_TOKEN }}

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Current version: $VERSION"

      - name: Check if tag already exists
        id: check_tag
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/v${{ steps.version.outputs.version }}"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Tag v${{ steps.version.outputs.version }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Tag v${{ steps.version.outputs.version }} does not exist, will create"
          fi

      - name: Create and push tag
        if: steps.check_tag.outputs.exists != 'true'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag v${{ steps.version.outputs.version }}
          git push origin v${{ steps.version.outputs.version }}

      - name: Tag already exists
        if: steps.check_tag.outputs.exists == 'true'
        run: |
          echo "‚ÑπÔ∏è  Skipping tag creation - v${{ steps.version.outputs.version }} already exists"