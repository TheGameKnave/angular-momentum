const os = require('os');
const fs = require('fs');
const path = require('path');
const dotenv = require('dotenv');

// Load .env from project root
const projectRoot = path.resolve(__dirname, '../../server/');
dotenv.config({ path: path.join(projectRoot, '.env') });

// Detect LAN IP
function getLocalIp() {
  const interfaces = os.networkInterfaces();
  for (const name of Object.keys(interfaces)) {
    for (const net of interfaces[name]) {
      if (net.family === 'IPv4' && !net.internal) {
        return net.address;
      }
    }
  }
  return 'localhost';
}

const localIp = getLocalIp();
const port = process.env.APP_PORT || '3000';

const envPath = path.join(__dirname, '../src/environments/environment.local.ts');
const baseUrl = `http://${localIp}:${port}`;
// const baseUrl = `https://angularmomentum.app`;

// Get Supabase config from environment or use defaults
const supabaseUrl = process.env.SUPABASE_URL || 'https://tyoyznpjxppchdyydbnf.supabase.co';
const supabaseKey = process.env.SUPABASE_PUBLIC_KEY || 'sb_publishable_35dVvVIWwou5S-E9MgV4pA_FkK2eOdZ';
const turnstileSiteKey = process.env.TURNSTILE_SITE_KEY || '1x00000000000000000000BB';

const output = `
// ðŸš¨ AUTO-GENERATED by set-local-env.js â€” do not edit manually.
export const ENVIRONMENT = {
  baseUrl: '${baseUrl}',
  env: 'local',
  turnstile_site_key: '${turnstileSiteKey}',
  supabase: {
    url: '${supabaseUrl}',
    publicKey: '${supabaseKey}',
  },
};
`;

fs.writeFileSync(envPath, output.trimStart());
console.log(`âœ… Wrote environment.local.ts with URL: ${baseUrl}`);
