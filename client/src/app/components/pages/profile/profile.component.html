<ng-container *transloco="let t">
  <p-card>
    <ng-template pTemplate="header">
      <div class="profile-header">
        <p-avatar
          [label]="getUserInitials()"
          size="xlarge"
          shape="circle"
          styleClass="profile-avatar"
        />
        <div class="profile-header-info">
          <h2>@if (usernameService.username()?.username) {{{ usernameService.username()?.username }}'s }{{ t('profile.Profile') }}</h2>
          <p>{{ authService.currentUser()?.email }}</p>
        </div>
      </div>
    </ng-template>

    <!-- Password Change Panel -->
    <p-panel
      [header]="t('profile.Change Password')"
      toggler="header" [toggleable]="true"
      [collapsed]="!passwordPanelExpanded()"
      (collapsedChange)="onPanelCollapsedChange($event)"
    >
      <form [formGroup]="passwordForm" (ngSubmit)="onSubmitPasswordChange()" class="auth-form profile-form">
          <!-- Current Password Input (only shown for regular password change, not reset flow) -->
          @if (!isPasswordResetFlow()) {
            <div class="form-field">
              <label for="current-password">{{ t('auth.Current Password') }}</label>
              <p-iconfield>
                <input
                  pInputText
                  id="current-password"
                  name="currentPassword"
                  formControlName="currentPassword"
                  type="password"
                  [attr.type]="showCurrentPassword() ? 'text' : 'password'"
                  [placeholder]="t('auth.Enter your current password')"
                  autocomplete="current-password"
                />
                <p-inputicon
                  styleClass="password-toggle-icon"
                  (mousedown)="onCurrentPasswordPeekStart()"
                  (mouseup)="onCurrentPasswordPeekEnd()"
                  (mouseleave)="onCurrentPasswordPeekEnd()"
                  (touchstart)="onCurrentPasswordPeekStart()"
                  (touchend)="onCurrentPasswordPeekEnd()"
                >
                  <i [class]="'pi ' + (showCurrentPassword() ? 'pi-eye-slash' : 'pi-eye')"></i>
                </p-inputicon>
              </p-iconfield>
              @if (passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched) {
                <small class="error-message">{{ t('auth.Current password is required') }}</small>
              }
            </div>
          }

          <!-- New Password Input -->
          <div class="form-field">
            <label for="new-password">{{ t('auth.New Password') }}</label>
            <p-iconfield>
              <input
                pInputText
                pTooltip="{{ passwordTooltip }}"
                tooltipPosition="top"
                [showDelay]="tooltipShowDelay"
                [hideDelay]="tooltipHideDelay"
                id="new-password"
                name="newPassword"
                formControlName="newPassword"
                type="password"
                [attr.type]="showNewPassword() ? 'text' : 'password'"
                [placeholder]="t('auth.Enter your new password')"
                autocomplete="new-password"
              />
              <p-inputicon
                styleClass="password-toggle-icon"
                (mousedown)="onNewPasswordPeekStart()"
                (mouseup)="onNewPasswordPeekEnd()"
                (mouseleave)="onNewPasswordPeekEnd()"
                (touchstart)="onNewPasswordPeekStart()"
                (touchend)="onNewPasswordPeekEnd()"
              >
                <i [class]="'pi ' + (showNewPassword() ? 'pi-eye-slash' : 'pi-eye')"></i>
              </p-inputicon>
            </p-iconfield>
            @if (passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched) {
              <small class="error-message">{{ t('auth.Password is required') }}</small>
            }
          </div>

          <!-- Confirm Password Input -->
          <div class="form-field">
            <label for="confirm-new-password">{{ t('auth.Confirm New Password') }}</label>
            <p-iconfield>
              <input
                pInputText
                id="confirm-new-password"
                name="confirmPassword"
                formControlName="confirmPassword"
                type="password"
                [attr.type]="showConfirmPassword() ? 'text' : 'password'"
                [placeholder]="t('auth.Re-enter your new password')"
                autocomplete="new-password"
              />
              <p-inputicon
                styleClass="password-toggle-icon"
                (mousedown)="onConfirmPasswordPeekStart()"
                (mouseup)="onConfirmPasswordPeekEnd()"
                (mouseleave)="onConfirmPasswordPeekEnd()"
                (touchstart)="onConfirmPasswordPeekStart()"
                (touchend)="onConfirmPasswordPeekEnd()"
              >
                <i [class]="'pi ' + (showConfirmPassword() ? 'pi-eye-slash' : 'pi-eye')"></i>
              </p-inputicon>
            </p-iconfield>
            @if (passwordForm.hasError('passwordMismatch') && passwordForm.get('confirmPassword')?.touched) {
              <small class="error-message">{{ t('auth.Passwords do not match') }}</small>
            }
          </div>

          <!-- Error Message -->
          @if (passwordError()) {
            <p-message severity="error" [text]="passwordError()!" />
          }

          <!-- Success Message -->
          @if (passwordSuccess()) {
            <p-message severity="success" [text]="t('auth.Password updated successfully!')" />
          }

          <!-- Submit Button -->
          <div class="form-actions">
            <p-button
              type="submit"
              [label]="t('auth.Update Password')"
              [loading]="passwordLoading()"
              [disabled]="passwordForm.invalid"
            />
          </div>
        </form>
    </p-panel>

    <!-- Email Change Panel -->
    <p-panel
      [header]="t('profile.Change Email Address')"
      toggler="header" [toggleable]="true"
      [collapsed]="!emailPanelExpanded()"
      (collapsedChange)="onEmailPanelCollapsedChange($event)"
    >
      <form [formGroup]="emailForm" (ngSubmit)="onSubmitEmailChange()" class="auth-form profile-form">
        <!-- New Email Input -->
        <div class="form-field">
          <label for="new-email">{{ t('profile.New Email Address') }}</label>
          <input
            pInputText
            id="new-email"
            name="newEmail"
            formControlName="newEmail"
            type="email"
            [placeholder]="t('profile.Enter your new email address')"
            autocomplete="email"
          />
          @if (emailForm.get('newEmail')?.invalid && emailForm.get('newEmail')?.touched) {
            <small class="error-message">{{ t('profile.Please enter a valid email address') }}</small>
          }
        </div>

        <!-- Info Message -->
        <p-message
          severity="info"
          [text]="t('profile.A verification link will be sent to your new email address. You must click the link to complete the change.')"
        />

        <!-- Error Message -->
        @if (emailError()) {
          <p-message severity="error" [text]="emailError()!" />
        }

        <!-- Success Message -->
        @if (emailSuccess()) {
          <p-message
            severity="success"
            [text]="t('profile.Verification email sent! Please check your new email address and click the confirmation link.')"
          />
        }

        <!-- Submit Button -->
        <div class="form-actions">
          <p-button
            type="submit"
            [label]="t('profile.Update Email')"
            [loading]="emailLoading()"
            [disabled]="emailForm.invalid"
          />
        </div>
      </form>
    </p-panel>

    <!-- Username Panel -->
    <p-panel
      [header]="usernameService.username()?.username ? t('profile.Change Username') : t('profile.Set Username')"
      toggler="header" [toggleable]="true"
      [collapsed]="!usernamePanelExpanded()"
      (collapsedChange)="onUsernamePanelCollapsedChange($event)"
    >
      <div class="auth-form profile-form">

        <!-- New Username Input -->
        <div class="form-field">
          <label for="username-input">{{ t('profile.Enter username') }}</label>
          <input
            pInputText
            pTooltip="{{ usernameTooltip }}"
            tooltipPosition="top"
            [showDelay]="tooltipShowDelay"
            [hideDelay]="tooltipHideDelay"
            id="username-input"
            type="text"
            [ngModel]="editedUsername()"
            (ngModelChange)="editedUsername.set($event)"
            [placeholder]="t('profile.Enter username')"
            autocomplete="username"
          />
          <small class="hint">{{ t('profile.Without a username, your profile is private') }}</small>
        </div>

        <!-- Error Message -->
        @if (usernameError()) {
          <p-message severity="error" [text]="usernameError()!" />
        }

        <!-- Success Message -->
        @if (usernameSuccess()) {
          <p-message severity="success" [text]="t('profile.Username updated successfully!')" />
        }

        <!-- Submit Button -->
        <div class="form-actions">
          <p-button
            [label]="t('Save')"
            (onClick)="onSaveUsername()"
            [loading]="usernameLoading()"
            [disabled]="!isUsernameDirty()"
          />
        </div>
      </div>
    </p-panel>

    <!-- Actions -->
    <div class="profile-logout">
      <p-button
        [label]="t('auth.Logout')"
        severity="secondary"
        icon="pi pi-sign-out"
        (onClick)="onLogout()"
      />
    </div>
  </p-card>

  <p-card>
    <!-- User Information -->
    <section class="profile-section">
      <h3>{{ t('profile.User Information') }}</h3>

      <dl class="info-list">
        <!-- Email -->
        <div class="info-row">
          <dt>{{ t('Email') }}:</dt>
          <dd>{{ authService.currentUser()?.email }}</dd>
        </div>

        <!-- User ID -->
        <div class="info-row">
          <dt>{{ t('profile.User ID') }}:</dt>
          <dd class="monospace">{{ authService.currentUser()?.id }}</dd>
        </div>

        <!-- Member Since -->
        @if (authService.currentUser()?.created_at) {
          <div class="info-row">
            <dt>{{ t('profile.Member Since') }}:</dt>
            <dd>
              <app-relative-time
                [timestamp]="authService.currentUser()?.created_at"
              />
            </dd>
          </div>
        }

        <!-- Last Sign In -->
        @if (authService.currentUser()?.last_sign_in_at) {
          <div class="info-row">
            <dt>{{ t('profile.Last Sign In') }}:</dt>
            <dd>
              <app-relative-time
                [timestamp]="authService.currentUser()?.last_sign_in_at"
              />
            </dd>
          </div>
        }
      </dl>
    </section>

    <hr />

    <!-- User Preferences -->
    <section class="profile-section">
      <h3>{{ t('profile.Preferences') }}</h3>

      <dl class="info-list">
        <!-- Timezone -->
        <div class="info-row">
          <dt>{{ t('profile.Timezone') }}:</dt>
          <dd class="timezone-select">
            <p-select
              [options]="commonTimezones"
              [ngModel]="selectedTimezone()"
              (ngModelChange)="selectedTimezone.set($event)"
              (onChange)="onTimezoneChange($event)"
              [loading]="timezoneLoading()"
              optionLabel="label"
              optionValue="value"
              [placeholder]="t('profile.Select timezone')"
            />
          </dd>
        </div>
      </dl>
    </section>

  </p-card>
  <p-card>

    <!-- Data & Privacy -->
    <section class="profile-section">
      <h3>{{ t('profile.Data & Privacy') }}</h3>

      <div class="data-actions">
        <!-- Export Data -->
        <div class="action-item">
          <p class="action-title">{{ t('profile.Export Your Data') }}</p>
          <p class="action-description">{{ t('profile.Download all your account data in JSON format') }}</p>
          <p-button
            [label]="t('profile.Export Data')"
            icon="pi pi-download"
            (onClick)="onExportData()"
            severity="secondary"
          />
          @if (exportError()) {
            <p-message severity="error" [text]="exportError()!" />
          }
        </div>

        @if (hasDataBackup()) {
          <!-- Export Previous Data (Migration Backup) -->
          <p-panel
            [header]="t('migration.Export Previous Data')"
            toggler="header"
            [toggleable]="true"
            [collapsed]="true"
          >
            <div class="action-item">
              <p class="action-description">{{ t('migration.Download a backup of your data from before the last update.') }}</p>
              <p-button
                [label]="t('migration.Export Previous Data')"
                icon="pi pi-download"
                (onClick)="onExportPreviousData()"
                [loading]="backupLoading()"
                severity="secondary"
              />
            </div>
          </p-panel>

          <hr />
        }

        <!-- Clear All Data -->
        <div class="action-item">
          <p class="action-title warning">{{ t('profile.Clear All Data') }}</p>
          <p class="action-description">{{ t('profile.Remove all stored preferences, notifications, and settings. Your account will remain active.') }}</p>
          <p-button
            [label]="t('profile.Clear Data')"
            icon="pi pi-eraser"
            (onClick)="onClearAllData()"
            severity="warn"
          />
        </div>

        <hr />

        <!-- Delete Account -->
        <div class="action-item">
          <p class="action-title danger">{{ t('profile.Delete Account') }}</p>
          <p class="action-description">{{ t('profile.Permanently delete your account and all associated data. This action cannot be undone.') }}</p>
          <p-button
            [label]="t('profile.Delete Account')"
            icon="pi pi-trash"
            (onClick)="onDeleteAccount()"
            severity="danger"
          />
        </div>
      </div>
    </section>
  </p-card>

<!-- Generic Confirmation Dialog -->
<app-dialog-confirm />
</ng-container>
